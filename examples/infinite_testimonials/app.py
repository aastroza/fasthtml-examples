import fasthtml.common as fh
from pydantic import BaseModel
from modal import Cls
from textwrap import dedent

class Testimonial(BaseModel):
    quote: str
    name: str
    role: str
    company: str

    def __ft__(self):
        return fh.Div(
            fh.Blockquote(fh.P(self.quote)),
            fh.H4(self.name),
            fh.P(f"{self.role}, {self.company}"),
        )
    
# Outlines and Modal stuff
Model = Cls.lookup("outlines-app", "Model")
m = Model()

schema = """{
    "title": "Testimonial",
    "type": "object",
    "properties": {
        "quote": {
            "title": "Quote",
            "type": "string"
        },
        "name": {
            "title": "Name",
            "type": "string"
        },
        "role": {
            "title": "Role",
            "description": "The professional role of the individual giving the testimonial.",
            "type": "string"
        },
        "company": {
            "title": "Company",
            "description": "The name of the company where the individual works or which they represent.",
            "type": "string"
        }
    },
    "required": ["quote", "name", "role", "company"]
}
"""

prompt_template = dedent(
                                    """
                                <|system|> You are a world class marketing copywriter. You must write new testimonials for a product by replying VALID JSON that matches the schema below.
                                
                                ```json
                                {schema}
                                ```
                                
                                Be creative and write new testimonials that are unique and engaging.<|end|>
                                <|user|> Write testimonials about the TimeMaster 2049, a time-stopping watch. A small, undistinguishable watch that can stop and start time whenever you want it to. <|end|>
                                <|assistant|>
                                """)

# Generate a single testimonial card
def generate_testimonial_card() -> Testimonial:
    result = m.generate.remote(schema.strip(),  prompt_template.format(schema=schema.strip()))
    return Testimonial(**result)
    

# FastHTML app setup
fasthtml_app, rt = fh.fast_app()

@rt("/")
def get():
    return fh.Titled('Infinite Fake Testimonials',
                  fh.Div(
                      fh.Div(generate_testimonial_card(), id="testimonial-card"),
                      fh.Div("This testimonial is fake. The product, person and company do not exist. All were generated by AI.", style='color: red;'),
                      fh.Div(
                          fh.Button("Next", id="next-btn", hx_get="/page", hx_target="#testimonial-card"),
                      )
                  ))

@rt("/page/")
def get():
    return generate_testimonial_card()


fh.serve(app="fasthtml_app")